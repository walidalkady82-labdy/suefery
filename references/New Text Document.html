<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mermaid Diagram Viewer</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Mermaid.js -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        /* Custom styles for the Mermaid container */
        .mermaid-container {
            width: 100%;
            height: 100%;
            min-height: 400px;
        }
        .mermaid {
            width: 100%;
            height: auto;
        }
        /* Fix for potential dark mode issues in some browsers */
        pre[data-mermaid-theme="dark"] {
            background: #333;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        
        <div class="bg-white p-6 rounded-lg shadow-lg mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Mermaid Diagram Viewer</h1>
            <p class="text-gray-600">Paste your Mermaid code into the text box below and click "Render" to see your diagram.</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            
            <!-- Left Panel: Code Input -->
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Mermaid Code</h2>
                <textarea id="mermaid-code" class="w-full h-96 p-4 font-mono text-sm border border-gray-300 rounded-md resize-y focus:outline-none focus:ring-2 focus:ring-blue-500">
sequenceDiagram
    participant Customer App
    participant S1 AI (Gemini API)
    participant SUEFERY Backend (Firestore)
    participant Partner App
    participant Dispatch System (Backend Logic)
    
    rect rgb(240, 248, 255)
        Note over Customer App, Partner App: Phase 1: The "Price & Availability Check" (The Concierge Loop)
    end

    %% === 1. Customer Request (S1) ===
    Customer App->>+S1 AI (Gemini API): 1. "I need a bag of Doritos, two Birells, and some gum."
    S1 AI (Gemini API)-->>-Customer App: 2. Parsed List: [Doritos (Large), Birell (x2), Gum (Any)]
    
    %% === 2. Request Dispatch ===
    Customer App->>+SUEFERY Backend (Firestore): 3. Submit "Draft Order" (Status: `Draft`)
    SUEFERY Backend (Firestore)-->>Dispatch System: 4. Find Best Partner (Nearest, 'Grocery' type)
    Dispatch System->>+Partner App: 5. NEW REQUEST: Price & Availability Check

    %% === 3. Partner "Quote" ===
    Note over Partner App: Partner sees items in "New Orders" tab.
    Partner App->>Partner App: 6. Partner physically checks items, inputs price for each (e.g., Doritos: 30 EGP, Birell: 15 EGP, Gum: 5 EGP)
    Partner App->>+SUEFERY Backend (Firestore): 7. `Submit Quote` (Status: `AwaitingCustomer`)
    
    %% === 4. Customer Confirmation (The "Checkout") ===
    SUEFERY Backend (Firestore)-->>+Customer App: 8. "Quote Ready! (Total: 65 EGP). Confirm?"
    Note over Customer App: Customer sees the itemized, priced list.
    Customer App->>+SUEFERY Backend (Firestore): 9. `Confirm & Pay`
    
    rect rgb(248, 255, 240)
        Note over SUEFERY Backend, Partner App: Phase 2: The "Delivery Flow" (Standard Sequence Begins)
    end
    
    %% === 5. Standard Flow Begins ===
    SUEFERY Backend (Firestore)-->>+Partner App: 10. PAID. (Status: `Preparing`)
    SUEFERY Backend (Firestore)-->>Dispatch System: 11. Find Nearest Rider (S3 Logic)
    
    Note over Partner App, Dispatch System: The rest of the flow (Rider Accept, Ready for Pickup, En Route, Completed) now proceeds as detailed in the 'SUEFERY_Order_Flow.md' file.
                </textarea>
                <button id="render-button" class="mt-4 w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow hover:bg-blue-700 transition duration-300">
                    Render Diagram
                </button>
            </div>

            <!-- Right Panel: Diagram Output -->
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Rendered Diagram</h2>
                <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-md mb-4" role="alert">
                    <strong class="font-bold">Error:</strong>
                    <span class="block sm:inline" id="error-text"></span>
                </div>
                <div class="mermaid-container overflow-auto border border-gray-200 rounded-md p-4">
                    <pre class="mermaid" id="mermaid-graph">
                        <!-- Mermaid will render here -->
                    </pre>
                </div>
            </div>

        </div>
    </div>

    <script>
        // Initialize Mermaid
        mermaid.initialize({ startOnLoad: false, theme: 'default' });

        const renderButton = document.getElementById('render-button');
        const codeInput = document.getElementById('mermaid-code');
        const graphOutput = document.getElementById('mermaid-graph');
        const errorMessage = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');

        // Function to render the diagram
        async function renderDiagram() {
            try {
                // Get the code from the textarea
                const code = codeInput.value;
                
                // Clear previous errors
                errorMessage.classList.add('hidden');
                
                // Use Mermaid's render function
                const { svg, bindFunctions } = await mermaid.render('graphDiv', code);
                
                // Update the graph output
                graphOutput.innerHTML = svg;
                
                // Bind any post-render functions (like interactions)
                if (bindFunctions) {
                    bindFunctions(graphOutput);
                }

            } catch (error) {
                // Show error message
                console.error(error);
                errorText.innerText = error.message || 'Failed to render diagram. Check code syntax.';
                errorMessage.classList.remove('hidden');
                graphOutput.innerHTML = ''; // Clear the graph area
            }
        }

        // Add event listener to the button
        renderButton.addEventListener('click', renderDiagram);

        // Initial render on page load
        window.addEventListener('load', () => {
            // We set the initial text content of the pre tag
            // to the value in the textarea for the first load.
            graphOutput.textContent = codeInput.value;
            mermaid.run({
                nodes: [graphOutput],
                suppressErrors: true // We handle errors manually
            }).catch(error => {
                console.error('Initial render failed:', error);
                errorText.innerText = error.message || 'Failed to render diagram. Check code syntax.';
                errorMessage.classList.remove('hidden');
                graphOutput.innerHTML = ''; // Clear the graph area
            });
        });
    </script>

</body>
</html>